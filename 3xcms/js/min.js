var app=angular.module("App","textAngular ui.router ui.tree ngAnimate ui.bootstrap ngTouch ngFileUpload chart.js dndLists fg gridster colorpicker.module ui.select".split(" "));app.config(["$compileProvider","$httpProvider","$stateProvider","$urlRouterProvider","$locationProvider",function(b,h,l,g,f){f.hashPrefix("!");g.otherwise("login");l.state("login",{url:"/login",title:"Anmeldung",templateUrl:"template/login.html"}).state("admin",{url:"/admin",templateUrl:"template/admin.html"}).state("admin/changePW",{url:"/admin/changePW",title:"Passwort \u00e4ndern",controller:"ChangePwCtrl",templateUrl:"template/adminChangePW.html"}).state("admin/grundeinstellung",{url:"/admin/grundeinstellung",title:"Lizenz- und Grundeinstellungen",controller:"GrundeinstellungCtrl",templateUrl:"template/adminGrundeinstellung.html"}).state("admin/spracheinstellung",{url:"/admin/spracheinstellung",title:"Spracheinstellungen",controller:"SpracheinstellungCtrl",templateUrl:"template/adminSpracheinstellung.html"}).state("admin/formular",{url:"/admin/formular",title:"Formular-Generator",controller:"FormCtrl",templateUrl:"template/adminFormBuilder.html"}).state("admin/portal",{url:"/admin/portal",title:"Portal-Generator",controller:"PortalCtrl",templateUrl:"template/adminPortalBuilder.html"}).state("admin/newsletter",{url:"/admin/newsletter",title:"Newsletter",controller:"NewsletterCtrl",templateUrl:"template/adminNewsletter.html"}).state("admin/template",{url:"/admin/template",title:"Template",controller:"TemplateCtrl",templateUrl:"template/adminTemplate.html"}).state("admin/seo",{url:"/admin/seo",title:"SEO & Metaangaben",controller:"SEOCtrl",templateUrl:"template/adminSEO.html"}).state("admin/menu",{url:"/admin/menu",title:"Men\u00fc",controller:"MenuCtrl",templateUrl:"template/adminMenu.html"}).state("admin/tmgangaben",{url:"/admin/tmgangaben/:tmg?lang",templateUrl:"template/adminTMGAngaben.html",title:"TMG Angaben",controller:"TMGAngabenCtrl"}).state("monitor",{url:"/monitor",title:"Monitor",templateUrl:"template/monitor.html",controller:"MonitorCtrl"}).state("news",{url:"/news/:id",title:"News",bereich:"news",templateUrl:"template/liste.html",controller:"NewsCtrl"}).state("dokument",{url:"/dokument/:id",title:"Dokument",bereich:"dokument",templateUrl:"template/liste.html",controller:"DokumentCtrl"}).state("galerie",{url:"/galerie/:id",title:"Galerie",bereich:"galerie",templateUrl:"template/liste.html",controller:"GalerieCtrl"}).state("katalog",{url:"/katalog/:id",title:"Katalog",bereich:"katalog",templateUrl:"template/liste.html",controller:"KatalogCtrl"}).state("termin",{url:"/termin/:id",title:"Termin",bereich:"termin",templateUrl:"template/liste.html",controller:"TerminCtrl"}).state("nutzer",{url:"/nutzer/:id",title:"Adressen",bereich:"nutzer",templateUrl:"template/liste.html",controller:"NutzerCtrl"}).state("shop",{url:"/shop",templateUrl:"template/shop.html"}).state("shop/grundeinstellung",{url:"/shop/grundeinstellung/:option?lang?currentPage?search",templateUrl:"template/shopGrundeinstellung.html",title:"Grundeinstellungen",controller:"ShopGrundeinstellungCtrl"}).state("shop/adressfelder",{url:"/shop/adressfelder",templateUrl:"template/shopAdressfelder.html",title:"Adressfelder",controller:"ShopAdressfelderCtrl"}).state("shop/parameter",{url:"/shop/parameter",templateUrl:"template/shopParameter.html",title:"Parameter",controller:"ShopParameterCtrl"}).state("shop/bildverwaltung",{url:"/shop/bildverwaltung",templateUrl:"template/shopBildverwaltung.html",title:"Bildverwaltung",controller:"ShopBildverwaltungCtrl"}).state("shop/lieferbedingungen",{url:"/shop/lieferbedingungen",templateUrl:"template/shopLieferbedingungen.html",title:"Lieferbedingungen",controller:"ShopLieferbedingungenCtrl"}).state("shop/zahlungsbedingungen",{url:"/shop/zahlungsbedingungen",templateUrl:"template/shopZahlungsbedingungen.html",title:"Zahlungsbedingungen",controller:"ShopZahlungsbedingungenCtrl"}).state("shop/zulagen",{url:"/shop/zulagen",templateUrl:"template/shopZulagen.html",title:"Zulagen",controller:"ShopNaturalzulagenCtrl"}).state("shop/budget",{url:"/shop/budget",title:"Budget",controller:"BudgetCtrl",templateUrl:"template/shopBudget.html"}).state("shop/gutscheine",{url:"/shop/gutscheine",templateUrl:"template/shopGutschein.html",title:"Gutscheine",controller:"ShopNaturalzulagenCtrl"});h.interceptors.push(["$q","$injector","Alert",function(b,e,d){return{responseError:function(c){d.loading(!1);401===c.status?e.get("$state").go("login"):403===c.status?(e.get("$state").go("login"),d.fail("Kein Zugriff!")):500===c.status&&d.fail(c.data);return b.reject(c)}}}])}]);app.run(["$rootScope","$state","$templateCache","$http","$uibModalStack","API","Alert",function(b,h,l,g,f,k,e){var d=!1,c=!1;b.$on("$stateChangeStart",function(m,g,l,n,p){(n=f.getTop())?(m.preventDefault(),f.dismiss(n.key)):(e.close(),d?b.nutzer||"login"==g.name?(b.pageTitle=g.title?g.title+" - 3X.Software":"3X.Software",document.body.scrollTop=document.documentElement.scrollTop=0,b.pageTitle=g.title):m.preventDefault():(b.nutzer||"login"==g.name||m.preventDefault(),c||(c=!0,k.get("session/status").then(function(m){b.version=m.version;b.domain=m.domain;b.lang=m.lang;m.nutzer&&(b.nutzer=m.nutzer,b.kats=m.kats,b.rechte=m.rechte,k.get("webshop/version").then(function(c){c.version&&(b.newVersion=c.version)}));d=!0;c=!1;b.nutzer?(h.go("login"!=g.name?g.name:"monitor",l),"1"==m.debug&&e.fail("<strong>Achtung</strong>: Debug-Modus ist aktiv! (Bitte in <strong>config.ini</strong> auf false setzen.)")):h.go("login");b.pageTitle=g.title}))))});b.$on("$stateChangeSuccess",function(c,d,e,f,k){b.state=d})}]);app.controller("ChangePwCtrl",["$scope","$state","API","Alert",function(b,h,l,g){b.title=h.current.title;b.pw={old:"","new":""};b.changePW=function(){l.post("nutzer/changePW",{old:b.pw.old,"new":b.pw["new"]}).then(function(f){b.form.sub=!1;b.pw={old:"","new":""};"OK"==f?g.success("Passwort ge\u00e4ndert."):g.fail("Altes Passwort nicht korrekt!")})}}]);app.controller("FormCtrl",["$scope","$state","$uibModal","API","Alert",function(b,h,l,g,f){b.title=h.current.title;b.load=function(){g.get("formular/search").then(function(f){b.formulare=f;b.formular=f[0]})};b.load();b.$watch("formular",function(){b.formular&&b.formular.id&&g.get("formular/data/"+b.formular.id).then(function(f){b.formular.fields=f.fields;b.formular.email=f.email;b.formular.spamschutz=f.spamschutz;b.formular.datenbank=f.datenbank;document.getElementById("hide").style=null})});b.change=function(){var k=function(b){if(b instanceof Array)for(var d=0;d<b.length;d++)k(b[d]);else null!=b.$_displayProperties&&delete b.$_displayProperties,null!=b.$_invalid&&delete b.$_invalid,null!=b.$_isDragging&&delete b.$_isDragging,null!=b.$_redraw&&delete b.$_redraw};k(b.formular.fields);g.put("formular/data",b.formular).then(function(){f.success("Formular ge\u00e4ndert.");b.load()})};b.create=function(){g.post("formular/data",b.formular).then(function(){f.success("Formular erstellt.");b.load()})};b["delete"]=function(){confirm("Formular l\u00f6schen?")&&g["delete"]("formular/data/"+b.formular.id).then(function(){f.success("Formular gel\u00f6scht.");b.load()})};b.vorschau=function(){l.open({animation:!1,template:'<div class="modal-header"><h3 class="modal-title">Vorschau</h3></div><div class="modal-body"><form novalidate class="form"><div fg-form fg-form-data="formular.fields" fg-schema="formular"></div></form></div><div class="modal-footer"><button class="btn btn-default btn-sm" type="button" ng-click="close()">Abbrechen</button></div>',scope:b,controller:["$uibModalInstance",function(f){b.close=function(){f.dismiss()}}]})};b.showTabelle=function(){l.open({animation:!1,size:"lg",templateUrl:"template/adminFormBuilderModalTable.html",resolve:{data:function(){return{id:b.formular.id,titel:b.formular.titel}}},controller:["$scope","$uibModalInstance","API","data",function(b,e,d,c){b.titel=c.titel;b.id=c.id;d.get("formular/table/"+c.id).then(function(c){c=c.split("\n");for(var d=[],e=c[0].split(","),m=1;m<c.length;m++){for(var f={},g=c[m].split(","),k=0;k<g.length;k++)f[e[k]]=g[k];d.push(f)}b.tableData=d});b.close=function(){e.dismiss()};b.csv=function(){var c="";b.tableData.head.forEach(function(b){c+=b+";"});c=c.slice(0,-1)+"\r\n";b.tableData.data.forEach(function(b){for(var d in b)c+=(null!=b[d]?b[d]:"")+";";c=c.slice(0,-1)+"\r\n"});b.url=(window.URL||window.webkitURL).createObjectURL(new Blob([c]))}}]})}}]);app.controller("GrundeinstellungCtrl",["$scope","$state","API","Alert",function(b,h,l,g){b.title=h.current.title;b.ex="\\w{5}-\\w{5}-\\w{5}-\\w{5}-\\w{5}";l.get("grundeinstellung").then(function(f){b.data=f;b.data.smtp||(b.data.smtp=[]);b.select=f.smtp[0]});b.change=function(){l.post("grundeinstellung",b.data).then(function(b){g.success("Lizenz- und Grundeinstellungen ge\u00e4ndert.")})};b.test=function(b,k){l.post("grundeinstellung",{testdata:b,testemail:k}).then(function(b){b?g.fail(b):g.success("E-Mail versendet.")})};b.checkKey=function(){if(b.data.lizenz){var f=b.data.lizenz.length;29<f?b.data.lizenz=b.data.lizenz.substring(0,29):0==f%6&&"-"!=b.data.lizenz.slice(-1)&&(--f,b.data.lizenz=[b.data.lizenz.slice(0,f),"-",b.data.lizenz.slice(f)].join(""))}};b.accDelete=function(f){confirm("Konto l\u00f6schen?")&&(b.data.smtp.splice(b.data.smtp.indexOf(f,1)),b.select=b.data.smtp[b.data.smtp.length-1])};b.accAdd=function(){b.data.smtp.push({name:"Neu"});b.select=b.data.smtp[b.data.smtp.length-1]};b.accDefault=function(f){b.data.smtp.forEach(function(b){b.standard="0"});f.standard="1"}}]);app.controller("MenuCtrl",["$scope","$state","$uibModal","API","Alert",function(b,h,l,g,f){b.title=h.current.title;b["delete"]=function(){return confirm("Men\u00fcpunkt L\u00f6schen?")};f.loading(!0);g.get("template/all").then(function(e){b.templates=e;g.get("menu/data").then(function(d){b.data=d?d:{};b.data.main=b.data.main||b.templates.main[0].url;b.data.items=b.data.items||[];g.get("portal/list").then(function(c){c&&0<c.length&&(b.portale=c);g.get("article/groups").then(function(c){b.groups=c;g.get("formular/list").then(function(c){b.formulare=c;f.loading(!1)})})})})});var k=!0;b.$watch("data",function(e,d){e!=d&&(k?k=!1:(f.loading(!0),g.put("menu/data",b.data).then(function(){f.loading(!1);b.data=[];b.data=e})))},!0);b.setStart=function(e){var d=function(b){b.start=null;b.nodes&&b.nodes.forEach(function(b){d(b)})};b.data.items.forEach(function(b){d(b)});e.start=!0};b.collapse=function(e){b.$broadcast(e?"angular-ui-tree:collapse-all":"angular-ui-tree:expand-all")};b.newItem=function(e){l.open({animation:!1,resolve:{data:function(){return{items:b.data.items,portale:b.portale,formulare:b.formulare,templates:b.templates,groups:b.groups}}},templateUrl:"template/adminMenuModalNeu.html",controller:["$scope","$uibModalInstance","data",function(b,c,m){b.portale=m.portale;b.formulare=m.formulare;b.templates=m.templates;b.groups=m.groups;b.values={mobil:!0,desktop:!0};b.close=function(){c.dismiss()};b.add=function(){if(e){e.nodes||(e.nodes=[]);var d=e.nodes}else d=m.items;d.push({values:b.values});c.close()}}]})};b.changeItem=function(e){l.open({animation:!1,templateUrl:"template/adminMenuModalNeu.html",resolve:{data:function(){return{portale:b.portale,formulare:b.formulare,templates:b.templates,groups:b.groups}}},controller:["$scope","$uibModalInstance","data",function(b,c,m){b.change=!0;b.groups=m.groups;b.portale=m.portale;b.formulare=m.formulare;b.templates=m.templates;b.hasChilds=e.nodes?!0:!1;b.values=angular.copy(e.values);b.close=function(){c.dismiss()};b.change=function(){e.values=b.values;c.close()}}]})}}]);app.controller("NewsletterCtrl",["$scope","$state","$uibModal","API","Alert",function(b,h,l,g,f){b.title=h.current.title;var k=function(){g.get("newsletter/list").then(function(e){b.rows=e})};k();b.send=function(b){l.open({animation:!1,size:"sm",template:'<div class="modal-header"><h3 class="modal-title">Versenden...</h3></div><div class="modal-body"><uib-progressbar class="progress-striped" ng-class="{\'active\': dynamic<max}" type="{{type}}" max="max" value="dynamic"><span style="color:white; white-space:nowrap;">{{ dynamic }}/ {{ max }}</span></uib-progressbar></div><div class="modal-footer"><button class="btn btn-default pull-right" ng-click="cancel();">{{type == "success" ? "OK" : "Abbechen"}}</button></div>',controller:["$scope","$uibModalInstance","API","$interval",function(d,c,e,f){d.abort=!1;d.recurse=function(){console.log(d.abort);d.abort||e.get("newsletter/send",{id:b}).then(function(b){d.max=b.max;d.dynamic=b.send;d.max>d.dynamic?d.recurse():d.type="success"})};d.recurse();d.cancel=function(){d.abort=!0;c.close()}}]}).result.then(function(){k()})};b.openModalNeu=function(b){l.open({animation:!1,size:"lg",templateUrl:"template/adminNewsletterModalNeu.html",controller:["$scope","$uibModalInstance","$sce","API","Alert",function(d,c,e,f,g){f.get("newsletter/suggestions").then(function(c){d.suggestions=c;b?f.get("newsletter/data/"+b).then(function(b){d.nl=b;"0"==d.nl.abgeschickt&&(d.nl.abgeschickt=null);if(d.nl.verteiler)d.an="verteiler";else if(d.nl.intern||d.nl.extern)d.an="adressen"}):d.nl={portal:d.suggestions.portale[0].id,smtp:d.suggestions.smtp[0].id}});d.$watch("nl.portal",function(b){b&&f.get("newsletter/portal/"+d.nl.portal).then(function(b){d.suggestions.portal=e.trustAsHtml(b)})});d.check=function(){return d.nl&&!d.nl.abgeschickt&&d.nl.betreff&&(d.nl.verteiler&&!angular.equals({},d.nl.verteiler)||d.nl.intern||d.nl.extern)};d.create=function(){g.loading(!0);f.post("newsletter/data",d.nl).then(function(){g.loading(!1);c.close()})};d.change=function(){g.loading(!0);f.put("newsletter/data",d.nl).then(function(){console.log(d.nl);g.loading(!1);c.close()})};d["delete"]=function(){confirm("Newsletter l\u00f6schen?")&&(g.loading(!0),f["delete"]("newsletter/data/"+d.nl.id).then(function(){g.loading(!1);c.close()}))};d.createPortal=function(){c.close(!0)};d.close=function(){c.dismiss()}}]}).result.then(function(b){b?h.go("admin/portal"):k()})};b.openModalAdressen=function(){l.open({animation:!1,templateUrl:"template/adminNewsletterModalAdressen.html",controller:["$scope","$uibModalInstance","API","Alert",function(b,d,c,m){b.filterVerteiler=function(c){return!b.verteiler.current||c.v&&-1!=c.v.indexOf(b.verteiler.current)?!0:!1};b.verteiler={};c.get("newsletter/verteiler").then(function(c){b.verteiler.list=c});c.get("newsletter/adressen").then(function(c){b.adressen=c});b.save=function(){m.loading(!0);var e=[];b.adressen.forEach(function(b){b.changed&&e.push({id:b.id,v_zo_typ:b.typ,aktiv:b.aktiv})});c.put("newsletter/adressen",e).then(function(b){m.loading(!1);d.close()})};b.addMail=function(){c.post("newsletter/adressen",{mail:b.newMail}).then(function(d){"ok"==d?(b.msg=null,b.newMail=null,c.get("newsletter/adressen").then(function(c){b.adressen=c})):"nomail"==d?b.msg="Keine E-Mail angegeben!":"invalid"==d&&(b.msg="E-Mail ist nicht korrekt!")})};b.csv=function(){var c="Nr;Name;E-Mail\r\n";b.filtered.forEach(function(b){c+=b.id+";"+b.name+";"+b.email+"\r\n"});b.url=(window.URL||window.webkitURL).createObjectURL(new Blob([c]))};b.close=function(){d.dismiss()}}]})};b.openModalLayout=function(){l.open({animation:!1,templateUrl:"template/adminNewsletterModalLayout.html",controller:["$scope","$uibModalInstance","API","Alert",function(b,d,c,m){b.fonts="Arial;Arial Narrow;Century Gothic;Comic Sans MS;Courier;Courier New;Haettenschweiler;Helvetica;Impact;Lucida Console;Microsoft Sans Serif;Tahoma;Times New Roman;Trebuchet MS;Verdana".split(";");var e={nl_bgcolor:"#D1C2BF",nl_head_font:"Arial",nl_head_size:15,nl_head_color:"#691B1B",nl_head_decoration:"none",nl_head_style:"italic",nl_head_weight:"bolder",nl_text_font:"Arial",nl_text_size:10,nl_text_color:"#000000",nl_text_decoration:"none",nl_text_style:"normal",nl_text_weight:"normal",nl_border_color:"#21FF5A"};c.get("newsletter/layout").then(function(c){c&&"null"!=c?(c.body.nl_text_size=parseInt(c.body.nl_text_size),c.body.nl_head_size=parseInt(c.body.nl_head_size),b.data=c):b.data={body:e}});b.save=function(){m.loading(!0);c.put("newsletter/layout",b.data).then(function(){m.loading(!1);d.close()})};b.close=function(){d.dismiss()}}]})};b.openModalVerteiler=function(){l.open({animation:!1,templateUrl:"template/adminNewsletterModalVerteiler.html",controller:["$scope","$uibModalInstance","API","Alert",function(b,d,c,m){b.verteiler={};var e=function(){c.get("newsletter/verteiler").then(function(c){b.verteiler.list=c;b.verteiler.current=b.verteiler.list[0]})};e();b.$watch("verteiler.current.v_id",function(d){d?c.get("newsletter/zuordnung/"+b.verteiler.current.v_id).then(function(c){b.verteiler.zuordnung=c}):b.verteiler.zuordnung=null});b.click=function(b){"1"==b.aktiv?b.zo=1==b.zo?0:1:alert("Diese Adresse steht auf der Blacklist!")};b.add=function(){m.loading(!0);c.post("newsletter/verteiler",b.verteiler.current).then(function(c){b.verteiler.current=null;e();m.loading(!1)})};b.change=function(){m.loading(!0);c.put("newsletter/verteiler",b.verteiler.current).then(function(b){m.loading(!1)})};b["delete"]=function(){confirm("Verteiler l\u00f6schen?")&&(m.loading(!0),c["delete"]("newsletter/verteiler/"+b.verteiler.current.v_id).then(function(c){b.verteiler.current=null;e();m.loading(!1)}))};b.save=function(){m.loading(!0);var e=[];b.verteiler.zuordnung.forEach(function(b){b.zo&&e.push({id:b.id,v_zo_typ:b.typ})});c.put("newsletter/zuordnung/"+b.verteiler.current.v_id,e).then(function(b){m.loading(!1);d.close()})};b.close=function(){d.dismiss()}}]})}}]);app.controller("PortalCtrl",["$scope","$state","$filter","$uibModal","API","Alert","$timeout",function(b,h,l,g,f,k,e){b.title=h.current.title;b.portal={fields:[{sizeX:6,row:0,col:0},{sizeX:1},{sizeX:1},{sizeX:1},{sizeX:1},{sizeX:1},{sizeX:1}]};b.gridsterOpts={columns:12,minColumns:1,minSizeX:1,resizable:{handles:["e","w"],stop:function(){b.change()}},draggable:{stop:function(){b.change()}}};f.get("portal/suggestions").then(function(d){d&&(b.suggestions=d)});b.load=function(){k.loading(!0);f.get("portal/list").then(function(d){d&&0<d.length&&(b.portale=d,b.portal=d[0]);k.loading(!1)})};b.load();b.$watch("portal",function(){b.portal&&b.portal.id&&f.get("portal/data/"+b.portal.id).then(function(d){b.portal.fields=d;document.getElementById("hide").style=null})});b.change=function(){k.loading(!0);b.portal.id?f.put("portal/data",b.portal).then(function(){k.loading(!1)}):f.post("portal/data",b.portal).then(function(){k.loading(!1);b.load()})};b["delete"]=function(){confirm("Portal l\u00f6schen?")&&f["delete"]("portal/data/"+b.portal.id).then(function(){k.success("Portal gel\u00f6scht.");b.load()})};b.addField=function(d){var c=0;b.portal.fields.forEach(function(b){b.id>c&&(c=b.id)});b.portal.fields.push({id:c+1,sizeX:1,data:d})};b.openModal=function(d){g.open({animation:!1,templateUrl:"template/adminPortalBuilderModalAdd.html",resolve:{data:function(){return{data:d.data,suggestions:b.suggestions}}},controller:["$scope","$uibModalInstance","data",function(b,d,e){b.bereiche="Formular Galerie News Termin Katalog HTML Artikel".split(" ");b.data={};b.suggestions=e.suggestions;angular.copy(e.data,b.data);b.$watch("data.bereich",function(c,d){d!=c&&(b.data={bereich:b.data.bereich},b.values=null);"Formular"==b.data.bereich?b.values=b.suggestions.formulare:"Galerie"==b.data.bereich&&(b.data.darstellung||(b.data.darstellung="slide"),b.values=b.suggestions.galerien);"News"!=b.data.bereich&&"Katalog"!=b.data.bereich||b.data.sortierung||(b.data.sortierung="sortindex");"News"!=b.data.bereich&&"Katalog"!=b.data.bereich||b.data.reihenfolge||(b.data.reihenfolge="DESC");if("News"==b.data.bereich||"Termin"==b.data.bereich||"Katalog"==b.data.bereich)b.data.template={detail:b.suggestions.templates.content.knt.detail[0].url}},!0);b.close=function(){d.dismiss()};b.searchArticle=function(c){(2<c.length||!b.itemArray)&&f.get("article/search/"+c).then(function(c){b.itemArray=c})};b.searchGroup=function(c){(2<c.length||!b.itemArray)&&f.get("article/groups/"+c).then(function(c){b.itemGroupsArray=c})};b.save=function(){d.close(b.data)}}]}).result.then(function(c){d.data=c;b.change()})}}]);app.controller("SEOCtrl",["$scope","$state","$filter","$uibModal","API","Alert",function(b,h,l,g,f,k){b.title=h.current.title;f.get("seo/data").then(function(e){e&&(b.data=e)});b.change=function(){f.put("seo/data",b.data)}}]);app.controller("SpracheinstellungCtrl",["$scope","$state","$filter","$uibModal","API","Alert",function(b,h,l,g,f,k){b.title=h.current.title;b.load=function(){f.get("spracheinstellung/lang").then(function(e){b.list=e;b.lang=e[0]})};b.load();b.$watch("lang",function(){b.lang&&b.lang.lang&&(b.langs=null,f.get("spracheinstellung/data",{lang:b.lang.lang}).then(function(e){b.langs=e}))});b.change=function(e){f.post("spracheinstellung/data",{lang:b.lang.lang,values:e})};b.newSprachvariable=function(){b.data={};b.error=!1;g.open({animation:!1,backdrop:"static",templateUrl:"template/modalNewSprachvariable.html",size:"md",controller:["$scope","$uibModalInstance",function(b,d){b.close=function(){d.dismiss()};b.create=function(c){b.error=!1;var d="de";angular.forEach(b.lang,function(b){b.select&&(d=b.lang)});f.post("spracheinstellung/sprachvariable",{data:c,lang:d}).then(function(c){-1==c?b.error=!0:(b.langs=c,b.close(),window.scrollTo(0,document.body.scrollHeight))})}}]})};b.modalLang=function(e){g.open({animation:!1,backdrop:"static",templateUrl:"template/modalLang.html",size:"sm",resolve:{lang:e?null:b.lang,create:e},controller:["$scope","$uibModalInstance","lang","create",function(b,c,e,g){b.lang=e;b.create=g;b.close=function(){c.dismiss()};b.addLang=function(){f.post("spracheinstellung/lang",b.lang).then(function(){k.success("Sprache hinzugef\u00fcgt.");c.close()})};b.delLang=function(){confirm("Sprache L\u00f6schen?")&&f["delete"]("spracheinstellung/lang/"+b.lang.lang).then(function(){k.success("Sprache gel\u00f6scht.");c.close()})}}]}).result.then(function(){b.load()})}}]);app.controller("TMGAngabenCtrl",["$scope","API","$stateParams","$state",function(b,h,l,g){b.l={};b.l.tmg=l.tmg?parseInt(l.tmg):1;h.get("spracheinstellung/lang").then(function(f){b.list=f;b.l.lang=f[0].lang;h.get("tmgangaben/menu/"+b.l.lang).then(function(f){b.tmg=f});b.$watchCollection("l",function(f){g.go(g.current,f,{notify:!1});h.get("tmgangaben/daten",f).then(function(e){b.data=e;b.data.sortindex=parseInt(e.sortindex)})})});b.save=function(f){f.lang=b.l.lang;f.tmg_id=b.l.tmg;h.put("tmgangaben/daten",f)}}]);app.controller("TemplateCtrl",["$scope","$filter","$uibModal","API","Alert",function(b,h,l,g,f){b.updateDefaults=function(){g.put("template/defaults",b.defaults)};b.openModal=function(b){l.open({animation:!1,size:"lg",templateUrl:"template/adminTemplateModal.html",resolve:{data:function(){return{item:b}}},controller:["$scope","$uibModalInstance","data",function(b,c,e){b.item=angular.copy(e.item);g.get("../template/"+e.item.url).then(function(c){b.item.template=c});b.close=function(){c.dismiss()};b.save=function(){console.log(b.item)}}]}).result.then(function(){k()})};var k=function(){g.get("template/defaults").then(function(e){b.defaults=e;g.get("template/all").then(function(d){b.templates=[{titel:"Allgemein",items:[{id:"style",name:"Style",templates:d.style},{id:"main",name:"Hauptlayout",templates:d.main},{id:"kopf",name:"Kopf",templates:d.head},{id:"fuss",name:"Fu\u00df",templates:d.foot}]},{titel:"Dialoge",items:[{id:"dialog_bild",name:"Bilder",templates:d.modal.bild},{id:"dialog_galerie",name:"Galerie",templates:d.modal.galerie},{id:"dialog_login",name:"Anmeldung",templates:d.modal.login},{id:"dialog_merkzettel",name:"Merkzettel",templates:d.modal.merkzettel},{id:"dialog_pw",name:"Passwort",templates:d.modal.passwort},{id:"dialog_warenkorb",name:"Warenkorb",templates:d.modal.warenkorb}]},{titel:"Shop",items:[{id:"registrierung",name:"Registrierung",templates:d.content.shop.registrierung},{id:"konto",name:"Konto",templates:d.content.shop.konto},{id:"artikel_list",name:"Artikel - Liste",templates:d.content.shop.list},{id:"artikel_detail",name:"Artikel - Detail",templates:d.content.shop.detail},{id:"artikel_gruppe",name:"Artikel - Gruppe",templates:d.content.shop.group},{id:"bestellvorschlag",name:"Bestellvorschlag",templates:d.content.shop.bestellvorschlag},{id:"merkzettel",name:"Merkzettel",templates:d.content.shop.merkzettel},{id:"warenkorb",name:"Warenkorb / Angebot / Lagerbuchung",templates:d.content.shop.warenkorb}]},{titel:"CMS",items:[{id:"katalog_list",name:"Katalog - Liste",templates:d.content.knt.list},{id:"katalog_detail",name:"Katalog - Detail",templates:d.content.knt.detail},{id:"news_list",name:"News - Liste",templates:d.content.knt.list},{id:"news_detail",name:"News - Detail",templates:d.content.knt.detail},{id:"termin_list",name:"Termin - Liste",templates:d.content.knt.list},{id:"termin_detail",name:"Termin - Detail",templates:d.content.knt.detail},{id:"dokument",name:"Dokument",templates:d.content.dokument.list},{id:"galerie",name:"Galerie",templates:d.content.galerie.list},{id:"formular",name:"Formular",templates:d.content.formular.detail},{id:"adresse",name:"Adresse",templates:d.content.nutzer.list},{id:"portal",name:"Portal",templates:d.content.portal},{id:"suche",name:"Suche",templates:d.content.search},{id:"tmg",name:"TMG",templates:d.content.tmg}]}]})})};k()}]);app.controller("MainCtrl",["$scope","$rootScope","$state","$stateParams","$anchorScroll","$uibModal","API","Alert",function(b,h,l,g,f,k,e,d){b.login=function(b){e.post("session/login",b).then(function(c){c&&1==c.cms?location.reload():(b=null,d.fail("Nutzerdaten \u00fcberpr\u00fcfen!"),l.go("login"))})};b.logout=function(){confirm("Abmelden?")&&(b.alert=null,h.nutzer=null,e.get("session/logout").then(function(){l.go("login")}))};b.checkVersion=function(){if(!h.version||!h.version.nr||!h.newVersion||h.newVersion===h.version.nr)return!1;for(var b=h.newVersion.split("."),d=h.version.nr.split("."),e=Math.min(b.length,d.length),f=0;f<e;f++){if(parseInt(b[f])>parseInt(d[f]))return!0;if(parseInt(b[f])<parseInt(d[f]))return!1}return b.length>d.length?!0:!1};b.updateCMS=function(){k.open({animation:!1,templateUrl:"template/modalUpdate.html",scope:b,controller:["$scope","$uibModalInstance","$http",function(b,d,f){b.getChangelog=function(){f.get("../api/webshop/changelog").then(function(c){b.changelog=c.data})};b.update=function(){confirm("Achting: Es ist m\u00f6glich, dass Anpassungen an Ihren System vorgenommen werden m\u00fcssen. Sind Sie sich sicher?")&&(b.status={backup:"run",update:"wait"},f.get("../3xbackup?backup").then(function(c){b.status.backup="ok";b.status.update="run";f.get("../api/webshop/update").then(function(c){f.get("../db_update/index.php?sm_start=starten").then(function(c){b.status.update="ok"},function(c){b.status.update="error"})},function(c){b.status.update="error"})},function(c){b.status.backup="error"}))};b.close=function(){b.status&&"ok"==b.status.update?location.reload():d.dismiss()}}]})};b.loading=!1;b.$on("alert:add",function(c,d){b.alert=d;f.yOffset=70;f("alert")});b.$on("alert:close",function(){b.alert=null});b.$on("alert:loading",function(c,d){b.loading=d})}]);app.controller("KatCtrl",["$scope","$rootScope","$uibModal","$q","$filter","API","Alert",function(b,h,l,g,f,k,e){b.openKatModal=function(d,c){l.open({animation:!1,backdrop:"static",templateUrl:"template/modalKat.html",controller:"ModalKatController",resolve:{data:function(){return{bereich:b.$parent.bereich,type:d,create:c,kats:b.kats[b.$parent.bereich_id],selectKat:b.$parent.selectKat}}}}).result.then(function(c){delete c.kat.kat;if("put"==c.http_type){e.loading(!0);var d=[];d.push(k.put(b.$parent.bereich+"/kategorien/data",c.kat));c.bild&&d.push(k.upload(b.$parent.bereich+"/kategorien/img/"+c.type+"/"+c.kat.id,c.bild));g.all(d).then(function(){location.reload()})}else"post"==c.http_type?(e.loading(!0),k.post(b.$parent.bereich+"/kategorien/data",c.kat).then(function(d){var f=[];c.bild&&f.push(k.upload(b.$parent.bereich+"/kategorien/img/"+c.type+"/"+d,c.bild));g.all(f).then(function(){location.reload()})})):"delete"==c.http_type&&confirm("Kategorie L\u00f6schen?")&&k["delete"](b.$parent.bereich+"/kategorien/data/"+c.type+"/"+c.kat.id).then(function(){e.success("Kategorie gel\u00f6scht.");k.get(b.$parent.bereich+"/kategorien/data").then(function(c){b.kats[b.$parent.bereich_id]=c})})})}}]);app.controller("ModalKatController",["$scope","$uibModalInstance","API","data","$rootScope",function(b,h,l,g,f){b.data={};angular.copy(g,b.data);b.data.create?("k"==b.data.type&&(b.data.kat={id_h:b.data.selectKat.hk.id,sicher_h:b.data.selectKat.hk.sicher}),"hk"==b.data.type&&(b.data.kat={lang:f.lang[0].lang})):(b.data.kat="k"==g.type?b.data.selectKat.k:b.data.selectKat.hk,l.get(b.data.bereich+"/kategorien/data/"+b.data.type+"/"+b.data.kat.id).then(function(f){var e=b.data.kat.kat;b.data.kat=f;b.data.kat.kat=e}));b.close=function(f){b.data.http_type=f;h.close(b.data)};b.removeImg=function(){confirm("Bild L\u00f6schen?")&&l["delete"](g.bereich+"/kategorien/img/"+g.type+"/"+b.data.kat.id).then(function(){b.data.kat.imglink=null})}}]);app.controller("BudgetCtrl",["$scope","API",function(b,h){h.get("budget/liste").then(function(h){b.data=h})}]);app.directive("myInhalt",function(){return{restrict:"E",templateUrl:"template/directiveInhalt.html",scope:{form:"=",link:"=",image:"=",imgtext:"=",text:"=","delete":"&",disableNotation:"=?"},controller:["$scope",function(b){b.data={showImg:!1};b.$watch("image",function(h,l,g){h!=l&&h&&h.name&&(b.link=h.name)});b.setImage=function(h){b.image=h};b.deleteImg=function(){b.image=null;b.link=null;b.imgtext&&(b.imgtext=null)}}]}});app.directive("convertToNumber",function(){return{require:"ngModel",link:function(b,h,l,g){g.$parsers.push(function(b){return parseInt(b,10)});g.$formatters.push(function(b){return""+b})}}});app.directive("myAccGroup",function(){return{restrict:"E",templateUrl:"template/directiveAccGroup.html",scope:{label:"=",values:"=",bereich:"=",kats:"="},controller:["$scope","$uibModal",function(b,h){b.isOpen=!1;b.removeZuordnung=function(h,g){h.splice(h.indexOf(g),1);b.isOpen=0==h.length?!1:!0};b.openZuordnungModal=function(l,g,f,k,e){l.preventDefault();l.stopPropagation();(f?h.open({animation:!1,templateUrl:"template/modalZuordnung.html",resolve:{data:function(){return{kats:g,bereich:f,values:k}}},controller:["$scope","$uibModalInstance","API","data",function(b,c,f,e){b.kats=e.kats;b.select={};b.bereich=e.bereich;b.selectHK=function(c){b.select.hk=b.select.hk!=c.id?c.id:null};b.selectK=function(c){b.select.k!=c.id?(b.select.k=c.id,b.values=[],e.values.items&&(e.values=e.values.items),f.get(e.bereich+"/search",{uk:c.id,q:"typ,imgthumb",cms:!0}).then(function(c){c.items&&(c=c.items);c.forEach(function(c){e.values&&e.values.some(function(b){if(b.id==c.id)return!0})||b.values.push(c)})})):b.select.k=null};b.select=function(b){c.close(b)};b.hasKats=function(b){return b.uks&&0<b.uks.length?!0:!1}}]}):h.open({animation:!1,template:"Formulare"==e?'<div class="modal-body"><table class="table table-condensed table-hover"><tr ng-repeat="row in values" style="cursor:pointer" ng-click="select(row)"><td>{{row.titel}}</td></tr></table></div>':'<div class="modal-body"><div><input class="form-control" placeholder="Artikelname" type="text" ng-model="searchText" ng-change="searchArticle(searchText)"></div><div ng-show="loading" class="text-primary" style="padding: 10px"><center><img class="xxx-rotate" src="../template/images/loading.png"></center></div><table class="table table-condensed table-hover"><tr ng-repeat="row in values" style="cursor:pointer" ng-click="select(row)"><td>{{row.id}} {{row.titel}}</td></tr></table></div>',resolve:{data:function(){return{values:k,label:e}}},controller:["$scope","$uibModalInstance","$timeout","API","data",function(b,c,f,e,g){"Formulare"==g.label&&e.get("Formulare"==g.label?"formular/search":"article/all").then(function(c){b.values=[];c.forEach(function(c){g.values&&g.values.some(function(b){if(b.id==c.id)return!0})||b.values.push(c)})});b.select=function(b){c.close(b)};var d;b.searchArticle=function(c){2<c.length&&(b.loading=!0,b.values=[],f.cancel(d),d=f(function(){e.get("article/search/"+c).then(function(c){c&&(b.values=[],c.forEach(function(c){g.values&&g.values.some(function(b){if(b.id==c.id)return!0})||b.values.push(c)}));b.loading=!1})},300))}}]})).result.then(function(d){k.push(d);b.isOpen=!0})}}]}});app.directive("uiSelectRequired",function(){return{require:"ngModel",link:function(b,h,l,g){g.$validators.uiSelectRequired=function(b,g){return b&&0<b.length?!0:!1}}}});app.directive("stringToNumber",function(){return{require:"ngModel",link:function(b,h,l,g){g.$parsers.push(function(b){return""+b});g.$formatters.push(function(b){return parseFloat(b)})}}});app.factory("API",["$http","Upload",function(b,h){return{get:function(h,g){var f="";if(g){var k=!0,e;for(e in g)f+=k?"?":"&",f+=e+"="+g[e],k=!1;h+=f}return b.get("../api/"+h).then(function(b){return b.data})},post:function(h,g){return b.post("../api/"+h,g).then(function(b){return b.data})},put:function(h,g){return b.put("../api/"+h,g).then(function(b){return b.data})},"delete":function(h){return b["delete"]("../api/"+h).then(function(b){return b.data})},upload:function(b,g,f){return h.upload({url:"../api/"+b,method:"POST",sendFieldsAs:"form",file:g,fields:f}).then(function(b){return b.data})}}}]);app.factory("Alert",["$rootScope",function(b){return{success:function(h){b.$broadcast("alert:add",{msg:h,type:"success"})},fail:function(h){b.$broadcast("alert:add",{msg:h,type:"danger"})},close:function(){b.$broadcast("alert:close")},loading:function(h){b.$broadcast("alert:loading",h)}}}]);app.factory("$exceptionHandler",["$log","$injector",function(b,h){return function(l,g){b.warn(l,g);h.get("$http").post("../api/webshop/log",{file:l.fileName,line:l.lineNumber,msg:l.toString(),stack:l.stack,cause:g}).then(function(){},function(){b.warn("Konnte nicht geloggt werden!")})}}]);app.controller("DokumentCtrl",["$scope","$rootScope","$uibModal","$stateParams","$state","$q","API","Alert",function(b,h,l,g,f,k,e,d){b.title=f.current.title;b.bereich=f.current.bereich;b.bereich_id=6;b.selectKat={};b.$watchGroup(["selectKat.hk","selectKat.k"],function(){b.search()});b.search=function(){b.rows=null;var c={};null!=b.selectKat.k&&(c.uk=b.selectKat.k.id);null!=b.selectKat.hk&&(c.hk=b.selectKat.hk.id);c.q="red,typ,stamp,sichtbar,freigabeanforderung,sicher";c.cms=!0;e.get("dokument/search",c).then(function(c){b.rows=c;b.currentPage=1})};b.toggleSichtbar=function(b){var c=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?!0:!1:null==b.sichtbar||"0"==b.sichtbar?!0:!1;e.put("dokument/sichtbar",{id:b.id,sichtbar:c}).then(function(){b.sichtbar=h.rechte.hasRedakteur?"0":c?"1":"0";b.freigabeanforderung=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?"1":"0":"0"})};b.openModal=function(c){l.open({animation:!1,backdrop:"static",templateUrl:"template/modalDokument.html",controller:"ModalDokumentCtrl",resolve:{data:function(){return{id:c,selectKat:b.selectKat}}}}).result.then(function(){b.search()})};""!=g.id&&b.openModal(g.id)}]);app.controller("ModalDokumentCtrl",["$scope","$rootScope","$uibModalInstance","$q","API","Alert","data",function(b,h,l,g,f,k,e){b.$watch("file",function(d,c,e){d&&(b.filename=d.name)});b.setFile=function(d){b.file=d};b.delImg=function(){b.dokument.imglink&&confirm("Bild l\u00f6schen?")&&(b.dokument.imglink=null,f.put("dokument/data",b.dokument))};b.load=function(){e.id?f.get("dokument/data/"+e.id,{q:"all",cms:!0}).then(function(d){b.dokument=d;b.filename=b.dokument.doclink;h.kats[6].some(function(c){var d=!1;c.uks&&c.uks.some(function(e){if(e.id==b.dokument.cat_nr)return b.hk=c,b.editable=e.edit,d=!0});return d})}):(b.dokument={},b.hk=e.selectKat.hk,e.selectKat.k&&(b.dokument.cat_nr=e.selectKat.k.id))};b.load();b.close=function(d){"post"==d?(k.loading(!0),f.post("dokument/data",b.dokument).then(function(c){if(b.file||b.bild){var d=[];b.file&&d.push(f.upload("dokument/file",b.file,{id:c}));b.bild&&d.push(f.upload("dokument/bild",b.bild,{id:c}));g.all(d).then(function(){k.loading(!1);l.close()})}else k.loading(!1),l.close()})):"put"==d?(k.loading(!0),d=[],d.push(f.put("dokument/data",b.dokument)),b.file&&d.push(f.upload("dokument/file",b.file,{id:b.dokument.id})),b.bild&&d.push(f.upload("dokument/bild",b.bild,{id:b.dokument.id})),g.all(d).then(function(){k.loading(!1);l.close()})):"delete"==d?confirm("Dokument l\u00f6schen?")&&(k.loading(!0),f["delete"]("dokument/data/"+b.dokument.id).then(function(){k.loading(!1);l.close()})):l.close(e)}}]);app.controller("GalerieCtrl",["$scope","$rootScope","$uibModal","$stateParams","$state","$q","API","Alert",function(b,h,l,g,f,k,e,d){b.title=f.current.title;b.bereich=f.current.bereich;b.bereich_id=5;b.selectKat={};b.$watchGroup(["selectKat.hk","selectKat.k"],function(){b.search()});b.search=function(){b.rows=null;var c={};null!=b.selectKat.k&&(c.uk=b.selectKat.k.id);null!=b.selectKat.hk&&(c.hk=b.selectKat.hk.id);c.q="red,stamp,imgthumb,sichtbar,freigabeanforderung,sicher";c.cms=!0;e.get("galerie/search",c).then(function(c){b.rows=c;b.currentPage=1})};b.toggleSichtbar=function(b){var c=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?!0:!1:null==b.sichtbar||"0"==b.sichtbar?!0:!1;e.put("galerie/sichtbar",{id:b.id,sichtbar:c}).then(function(){b.sichtbar=h.rechte.hasRedakteur?"0":c?"1":"0";b.freigabeanforderung=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?"1":"0":"0"})};b.openModal=function(c){l.open({animation:!1,backdrop:"static",templateUrl:"template/modalGalerie.html",controller:"ModalGalerieCtrl",resolve:{data:function(){return{id:c,selectKat:b.selectKat}}}}).result.then(function(){b.search()})};""!=g.id&&b.openModal(g.id)}]);app.controller("ModalGalerieCtrl",["$scope","$rootScope","$uibModalInstance","$uibModal","$q","API","Alert","data",function(b,h,l,g,f,k,e,d){angular.element(window).bind("dragover",function(b){b.preventDefault()});angular.element(window).bind("drop",function(b){b.preventDefault()});b.dragoverCallback=function(b,d,e,f){return!0};b.dropCallback=function(b,d,e,f,g,h){return e};b.load=function(){d.id?k.get("galerie/data/"+d.id,{q:"all",cms:!0}).then(function(c){b.galerie=c;h.kats[5].some(function(c){var d=!1;c.uks&&c.uks.some(function(e){if(e.id==b.galerie.cat_nr)return b.hk=c,b.editable=e.edit,d=!0});return d})}):(b.galerie={},b.hk=d.selectKat.hk,d.selectKat.k&&(b.galerie.cat_nr=d.selectKat.k.id))};b.load();b.select=function(c){g.open({animation:!1,backdrop:"static",size:"lg",templateUrl:"template/modalBild.html",resolve:{data:function(){return{images:b.galerie.img,editable:b.editable,index:c}}},controller:["$scope","$uibModalInstance","API","Alert","data",function(b,c,d,e,f){b.active=f.index;b.editable=f.editable;b.images=f.images;b["delete"]=function(){confirm("Bild L\u00f6schen?")&&c.close({type:"deleteImage",value:b.images[b.active].img})};b.close=function(){c.dismiss()}}]}).result.then(function(c){e.loading(!0);k["delete"]("galerie/img/"+c.value).then(function(){b.load();e.loading(!1)})})};b.close=function(c){"post"==c?(e.loading(!0),k.post("galerie/data",b.galerie).then(function(c){b.galerie.id=c;d.id=c;e.loading(!1);b.galerie.id&&l.close()})):"put"==c?(e.loading(!0),k.put("galerie/data",b.galerie).then(function(){e.loading(!1);l.close()})):"delete"==c?confirm("Galerie L\u00f6schen?")&&(e.loading(!0),k["delete"]("galerie/data/"+b.galerie.id).then(function(){e.loading(!1);l.close()})):l.dismiss()};b.upload=function(c){if(c&&c.length){e.loading(!0);for(var d=[],g=0;g<c.length;g++)d.push(k.upload("galerie/img",c[g],{id:b.galerie.id}));f.all(d).then(function(){b.load();e.loading(!1)})}}}]);app.controller("KatalogCtrl",["$scope","$rootScope","$uibModal","$stateParams","$state","$window","$q","API","Alert",function(b,h,l,g,f,k,e,d,c){b.title=f.current.title;b.bereich=f.current.bereich;b.bereich_id=4;b.selectKat={};b.$watchGroup(["selectKat.hk","selectKat.k"],function(){b.search()});b.search=function(){b.rows=null;var c={};null!=b.selectKat.k&&(c.uk=b.selectKat.k.id);null!=b.selectKat.hk&&(c.hk=b.selectKat.hk.id);c.q="red,stamp,imgthumb,sichtbar,freigabeanforderung,date1,date2,archiv,upcoming,sicher";c.cms=!0;d.get("katalog/search",c).then(function(c){b.rows=c.items?c.items:[];b.currentPage=1})};b.toggleSichtbar=function(b){var c=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?!0:!1:null==b.sichtbar||"0"==b.sichtbar?!0:!1;d.put("katalog/sichtbar",{id:b.id,sichtbar:c}).then(function(){b.sichtbar=h.rechte.hasRedakteur?"0":c?"1":"0";b.freigabeanforderung=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?"1":"0":"0"})};b.openModal=function(c){l.open({animation:!1,backdrop:"static",templateUrl:"template/modalKatalog.html",controller:"ModalKatalogCtrl",resolve:{data:function(){return{id:c,selectKat:b.selectKat}}}}).result.then(function(){b.search()})};""!=g.id&&b.openModal(g.id)}]);app.controller("ModalKatalogCtrl",["$scope","$rootScope","$uibModalInstance","$uibModal","$q","API","Alert","data",function(b,h,l,g,f,k,e,d){b.minDate=new Date;b.katalog={};b.data={image:null};b.setFile=function(c){b.file=c};b.$watch("file",function(c,d,e){b.filename=c?c.name:null});b.load=function(){d.id?k.get("katalog/data/"+d.id,{q:"all",cms:!0}).then(function(c){b.katalog=c;c.galerie||(b.katalog.galerie=[]);c.katalog||(b.katalog.katalog={items:[]});c.news||(b.katalog.news={items:[]});c.termin||(b.katalog.termin={items:[]});c.dokument||(b.katalog.dokument=[]);c.nutzer||(b.katalog.nutzer=[]);c.formular||(b.katalog.formular=[]);c.artikel||(b.katalog.artikel=[]);b.filename=c.doclink;b.katalog.date1&&(b.katalog.date1=new Date(b.katalog.date1));b.katalog.date2&&(b.katalog.date2=new Date(b.katalog.date2));h.kats[4].some(function(c){var d=!1;c.uks&&c.uks.some(function(e){if(e.id==b.katalog.cat_nr)return b.hk=c,b.editable=e.edit,d=!0});return d})}):(b.katalog={katalog:{items:[]},news:{items:[]},termin:{items:[]},dokument:[],galerie:[],nutzer:[],formular:[],artikel:[]},b.hk=d.selectKat.hk,d.selectKat.k&&(b.katalog.cat_nr=d.selectKat.k.id))};b.load();b.deleteFile=function(){confirm("Dokument l\u00f6schen?")&&k["delete"]("katalog/file/"+b.katalog.id).then(function(){b.filename=null;b.katalog.docnotation=null;b.katalog.doclink=null})};b.deleteImage=function(){confirm("Bild l\u00f6schen?")&&k["delete"]("katalog/img/"+b.katalog.id).then(function(){b.imagename=null;b.katalog.imgnotation=null;b.katalog.imglink=null})};b.close=function(c){"post"==c?(e.loading(!0),k.post("katalog/data",b.katalog).then(function(c){var d=[];b.file&&d.push(k.upload("katalog/file",b.file,{id:c}));b.data.image&&d.push(k.upload("katalog/img",b.data.image,{id:c}));f.all(d).then(function(){e.loading(!1);l.close()})})):"put"==c?(e.loading(!0),c=[],c.push(k.put("katalog/data",b.katalog)),b.file&&c.push(k.upload("katalog/file",b.file,{id:b.katalog.id})),b.data.image&&c.push(k.upload("katalog/img",b.data.image,{id:b.katalog.id})),f.all(c).then(function(){e.loading(!1);l.close()})):"delete"==c?confirm("Katalog l\u00f6schen?")&&(e.loading(!0),k["delete"]("katalog/data/"+b.katalog.id).then(function(){e.loading(!1);l.close()})):l.close()}}]);app.controller("MonitorCtrl",["$scope","API","Alert",function(b,h,l){b.mdata=null;h.get("monitor/data").then(function(g){g.dates||(g.dates=[]);b.mdata=g;b.years=[];for(var f=0;f<b.mdata.dates.length;f++){g=!1;for(var h=0;h<b.years.length;h++)b.years[h]==b.mdata.dates[f].y&&(g=!0);g||b.years.push(b.mdata.dates[f].y)}0<b.years.length&&(b.year=b.years[b.years.length-1]);b.months=[];for(f=0;f<b.mdata.dates.length;f++){g=!1;for(h=0;h<b.months.length;h++)b.months[h]==b.mdata.dates[f]&&(g=!0);g||b.months.push(b.mdata.dates[f])}b.month=b.months[b.months.length-1]});b.$watchGroup(["year","month"],function(g,f,h){b.updateStats()});b.updateStats=function(){var g=function(f,g){b.labels=f;b.stats=[g];var e=0,d=0;g.forEach(function(b){e+=parseInt(b);d+=1});b.durchschnitt=Math.round(e/d);b.gesamt=e;l.loading(!1)};b.year&&(b.month?b.year&&(l.loading(!0),h.get("monitor/statsofmonth",{year:b.year,month:b.month.m}).then(function(b){g(b.labels,b.stats)})):(l.loading(!0),h.get("monitor/statsofyear",{year:b.year}).then(function(b){g(b.labels,b.stats)})))}}]);app.controller("NewsCtrl",["$scope","$rootScope","$uibModal","$stateParams","$state","$q","API","Alert",function(b,h,l,g,f,k,e,d){b.title=f.current.title;b.bereich=f.current.bereich;b.bereich_id=1;b.selectKat={};b.$watchGroup(["selectKat.hk","selectKat.k"],function(){b.search()});b.search=function(){b.rows=null;var c={};null!=b.selectKat.k&&(c.uk=b.selectKat.k.id);null!=b.selectKat.hk&&(c.hk=b.selectKat.hk.id);c.q="red,stamp,imgthumb,sichtbar,freigabeanforderung,date1,date2,archiv,upcoming,sicher";c.cms=!0;e.get("news/search",c).then(function(c){b.rows=c.items?c.items:[];b.currentPage=1})};b.toggleSichtbar=function(b){var c=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?!0:!1:null==b.sichtbar||"0"==b.sichtbar?!0:!1;e.put("news/sichtbar",{id:b.id,sichtbar:c}).then(function(){b.sichtbar=h.rechte.hasRedakteur?"0":c?"1":"0";b.freigabeanforderung=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?"1":"0":"0"})};b.openModal=function(c){l.open({animation:!1,backdrop:"static",templateUrl:"template/modalNews.html",controller:"ModalNewsCtrl",resolve:{data:function(){return{id:c,selectKat:b.selectKat}}}}).result.then(function(){b.search()})};""!=g.id&&b.openModal(g.id)}]);app.controller("ModalNewsCtrl",["$scope","$rootScope","$uibModalInstance","$uibModal","$q","API","Alert","data",function(b,h,l,g,f,k,e,d){b.minDate=new Date;b.news={};b.data={image:null};b.setFile=function(c){b.file=c};b.$watch("file",function(c,d,e){b.filename=c?c.name:null});b.load=function(){if(d.id)k.get("news/data/"+d.id,{q:"all",cms:!0}).then(function(c){b.news=c;c.galerie||(b.news.galerie=[]);c.katalog||(b.news.katalog={items:[]});c.news||(b.news.news={items:[]});c.termin||(b.news.termin={items:[]});c.dokument||(b.news.dokument=[]);c.nutzer||(b.news.nutzer=[]);c.formular||(b.news.formular=[]);c.artikel||(b.news.artikel=[]);b.filename=c.doclink;b.news.date1&&(b.news.date1=new Date(b.news.date1));b.news.date2&&(b.news.date2=new Date(b.news.date2));h.kats[1].some(function(c){var d=!1;c.uks&&c.uks.some(function(e){if(e.id==b.news.cat_nr)return b.hk=c,b.editable=e.edit,d=!0});return d})});else{var c=new Date,e=new Date;e.setDate(e.getDate()+7);b.news={katalog:{items:[]},news:{items:[]},termin:{items:[]},dokument:[],galerie:[],nutzer:[],formular:[],artikel:[],date1:c,date2:e};b.hk=d.selectKat.hk;d.selectKat.k&&(b.news.cat_nr=d.selectKat.k.id)}};b.load();b.deleteFile=function(){confirm("Dokument l\u00f6schen? ")&&k["delete"]("news/file/"+b.news.id).then(function(){b.filename=null;b.news.docnotation=null;b.news.doclink=null})};b.deleteImage=function(){confirm("Bild l\u00f6schen?")&&k["delete"]("news/img/"+b.news.id).then(function(){b.imagename=null;b.news.imgnotation=null;b.news.imglink=null})};b.close=function(c){"post"==c?(e.loading(!0),k.post("news/data",b.news).then(function(c){var d=[];b.file&&d.push(k.upload("news/file",b.file,{id:c}));b.data.image&&d.push(k.upload("news/img",b.data.image,{id:c}));f.all(d).then(function(){e.loading(!1);l.close()})})):"put"==c?(e.loading(!0),c=[],c.push(k.put("news/data",b.news)),b.file&&c.push(k.upload("news/file",b.file,{id:b.news.id})),b.data.image&&c.push(k.upload("news/img",b.data.image,{id:b.news.id})),f.all(c).then(function(){e.loading(!1);l.close()})):"delete"==c?confirm("Termin l\u00f6schen?")&&(e.loading(!0),k["delete"]("news/data/"+b.news.id).then(function(){e.loading(!1);l.close()})):l.close()}}]);app.controller("NutzerCtrl",["$scope","$rootScope","$uibModal","$stateParams","$state","$q","API","Alert",function(b,h,l,g,f,k,e,d){b.title=f.current.title;b.bereich=f.current.bereich;b.bereich_id=3;b.selectKat={};b.$watchGroup(["selectKat.hk","selectKat.k"],function(){b.search()});b.search=function(){b.rows=null;var c={};null!=b.selectKat.k&&(c.uk=b.selectKat.k.id);null!=b.selectKat.hk&&(c.hk=b.selectKat.hk.id);c.q="red,stamp,imgthumb,sichtbar,freigabeanforderung,sicher";c.cms=!0;e.get("nutzer/search",c).then(function(c){b.rows=c;b.currentPage=1})};b.toggleSichtbar=function(b){var c=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?!0:!1:null==b.sichtbar||"0"==b.sichtbar?!0:!1;e.put("nutzer/sichtbar",{id:b.id,sichtbar:c}).then(function(){b.sichtbar=h.rechte.hasRedakteur?"0":c?"1":"0";b.freigabeanforderung=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?"1":"0":"0"})};b.openModal=function(c){l.open({animation:!1,backdrop:"static",templateUrl:"template/modalNutzer.html",controller:"ModalNutzerCtrl",resolve:{data:function(){return{id:c,selectKat:b.selectKat}}}}).result.then(function(f){if("put"==f.http_type){d.loading(!0);var g=[];g.push(e.put("nutzer/data",f.nutzer));f.files.file&&g.push(e.upload("nutzer/file",f.files.file,{id:c}));f.files.bild&&g.push(e.upload("nutzer/img",f.files.bild,{id:c}));k.all(g).then(function(){d.loading(!1);d.success(f.nutzer.name2+" ge\u00e4ndert.");b.search()})}else"post"==f.http_type?(d.loading(!0),e.post("nutzer/data",f.nutzer).then(function(c){var g=[];f.files.file&&g.push(e.upload("nutzer/file",f.files.file,{id:c}));f.files.bild&&g.push(e.upload("nutzer/img",f.files.bild,{id:c}));k.all(g).then(function(){d.loading(!1);d.success(f.nutzer.name2+" erstellt.");b.search()})})):"delete"==f.http_type&&confirm("Nutzer L\u00f6schen?")&&(d.loading(!0),e["delete"]("nutzer/data/"+c).then(function(){d.loading(!1);d.success(f.nutzer.name2+" gel\u00f6scht.");b.search()}))})};""!=g.id&&b.openModal(g.id)}]);app.controller("ModalNutzerCtrl",["$scope","$rootScope","$uibModalInstance","$uibModal","API","data","$http",function(b,h,l,g,f,k,e){b.files={};b.n={};b.load=function(){k.id?f.get("nutzer/data/"+k.id,{q:"all",cms:!0}).then(function(d){b.n=d;b.filename=d.doclink;h.kats[3].some(function(c){var d=!1;c.uks&&c.uks.some(function(e){if(e.id==b.n.cat_nr)return b.hk=c,b.editable=e.edit,d=!0});return d})}):(b.n={},b.hk=k.selectKat.hk,k.selectKat.k&&(b.n.cat_nr=k.selectKat.k.id))};b.load();b.setFile=function(d){b.files.file=d};b.$watch("files.file",function(d,c,e){b.filename=d?d.name:null});b.openBildModal=function(){g.open({animation:!1,backdrop:"static",templateUrl:"template/modalBild.html",size:"sm",resolve:{image:function(){return{images:[{img:b.n.imglink,imgnotation:b.n.imgnotation,file:b.files.bild}]}}},controller:["$scope","$uibModalInstance","image",function(b,c,e){b.images=e.images;b.editable=!0;b.disableWeblink=!0;b["delete"]=function(){c.close("delete")};b.close=function(){c.close(b.images[0].imgnotation)}}]}).result.then(function(d){"delete"==d?(b.n.imglink&&confirm("Bild L\u00f6schen?")&&f["delete"]("nutzer/img/"+b.n.id).then(function(){b.n.imglink=null;b.n.imgnotation=null}),b.files.bild=null):b.n.imgnotation=d})};b.close=function(d){var c={};c.http_type=d;"cancel"!=c.http_type&&(c.nutzer=b.n,"delete"!=c.http_type&&(c.nutzer.cat_nr=b.n.cat_nr,c.files=b.files));l.close(c)};b.removeFile=function(){confirm("Datei L\u00f6schen?")&&f["delete"]("nutzer/file/"+b.n.id).then(function(){b.n.doclink=null;b.n.docnotation=null;b.filename=null})};b.getGeocode=function(d){b.n.lat="";b.n.lng="";e.get("https://maps.googleapis.com/maps/api/geocode/json?address="+(d.strasse?d.strasse:"")+","+d.plz+","+d.ort).then(function(c){c.data&&"OK"==c.data.status&&(c=c.data.results[0].geometry.location,b.n.lat=c.lat,b.n.lng=c.lng)})}}]);app.controller("ShopAdressfelderCtrl",["$scope","API","$stateParams","$state","Alert","$timeout",function(b,h,l,g,f,k){b.l={};b.data={};var e;h.get("spracheinstellung/lang").then(function(d){b.list=d;b.l.lang=d[0].lang;h.get("adressfelder",b.l).then(function(c){b.data=c})});b.save=function(d){f.close();h.put("adressfelder",{lang:b.l.lang,values:d}).then(function(b){window.scrollTo(0,0);f.success("\u00c4nderung gespeichert!");e&&k.cancel(e);e=k(function(){f.close()},5E3)})};b.moveToEnd=function(b,c){var d=2*c.length;b.target.setSelectionRange(d,d)}}]);app.controller("ShopBildverwaltungCtrl",["$scope","API","Alert","$timeout",function(b,h,l,g){var f;h.get("bildverwaltung").then(function(f){b.data=f});b.action=function(k){l.close();h.put("bildverwaltung/"+k).then(function(e){b.data=e;1==k?l.success("Datenbankeintr\u00e4ge und Thumbnails gel\u00f6scht!"):2==k?l.success("Datenbankeintr\u00e4ge entfernt!"):3==k?l.success("Bilder f\u00fcr nicht indizierte Artikel gesucht und Thumbnails erstellt!"):4==k&&l.success("Bildindex f\u00fcr sp\u00e4tere Zuordnung erstellt!");f&&g.cancel(f);f=g(function(){l.close()},5E3)})}}]);app.controller("ShopGrundeinstellungCtrl",["$scope","API","$stateParams","$state","$timeout","$uibModal",function(b,h,l,g,f,k){b.l={};b.x={};b.y={};b.land={};b.data=[];b.error=!1;b.l.currentPage=l.currentPage?parseInt(l.currentPage):1;b.l.option=l.option?parseInt(l.option):1;b.l.search=l.search?l.search:"";h.get("spracheinstellung/lang").then(function(e){b.list=e;b.l.lang=e[0].lang;var d;b.$watchCollection("l",function(c,e){c.option!=e.option&&(b.l.currentPage=1,b.l.search="");d&&f.cancel(d);d=f(function(){g.go(g.current,c,{notify:!1});b.data=[];1==c.option&&h.get("shopeinstellung/optionen",c).then(function(c){b.bereiche=c});2==c.option&&h.get("shopeinstellung/land",c).then(function(c){b.data=c;if(b.data.liste)for(i=0;i<b.data.liste.length;i++)b.data.liste[i].standard=0==b.data.liste[i].standard?!1:!0});3==c.option&&h.get("shopeinstellung/standardrechte").then(function(c){b.data=c});4==c.option&&h.get("shopeinstellung/kundenrechte",c).then(function(c){b.data=c});5==c.option&&h.get("shopeinstellung/bezeichnungen",c).then(function(c){b.data=c});6==c.option&&h.get("shopeinstellung/artikelspalten").then(function(c){b.data=c})},500)})});b.get=function(e,d){b.values=[];h.get("shopeinstellung/"+e+"/"+d,b.l).then(function(c){b.values=c})};b.update=function(e,d){d?d.lang=b.l.lang:d="";h.put("shopeinstellung/"+e,d)};b.add=function(e,d,c){e&&(d={Land:e.sl_kuerzel,LgNr:d},d[b.l.lang]=e[b.l.lang],b.data.gruppen[c].Values||(b.data.gruppen[c].Values=[]),b.data.gruppen[c].Values.push(d),h.post("shopeinstellung/laendergruppen/add",d))};b["delete"]=function(e,d){if("land"==e&&b.data.gruppen){var c=0;angular.forEach(b.data.gruppen,function(e){if(e.Values){var f=0;angular.forEach(e.Values,function(e){e.Land==d&&b.data.gruppen[c].Values.splice(f,1);f++})}c++})}h["delete"]("shopeinstellung/"+e+"/"+d)};b.create=function(e,d){b.error=!1;"laendergruppen"==e?(b.data.gruppen||(b.data.gruppen=[]),angular.forEach(b.data.gruppen,function(c){if(c.LgNr==d.LgNr)return b.error=!0}),b.error||b.data.gruppen.push(d)):"land"==e&&(b.data.liste||(b.data.liste=[]),angular.forEach(b.data.liste,function(c){if(c.sl_kuerzel==d.sl_kuerzel)return b.error=!0,window.scrollTo(0,0),!0}),b.error||b.data.liste.push(d));b.error||h.post("shopeinstellung/"+e,d)};b.openKundenrechtModal=function(e){b.Kunde=e;k.open({animation:!1,backdrop:"static",templateUrl:"template/modalShopGrundeinstellungRechte.html",scope:b,controller:"ModalRechteController"})};b.setStandard=function(e){for(a=0;a<b.data.length;a++)a!=e&&(b.data[a].standard=!1);b.update("laender",b.data[e])};b.update_selected_spalten=function(b,d){b[d]="False"==b[d]?"True":"False";h.post("shopeinstellung/artikelspalten",b)}}]);app.filter("remove",function(){return function(b,h){var l=[];if(b)for(i=0;i<b.length;i++){var g=!0;angular.forEach(h,function(f){f.Land==b[i].sl_kuerzel&&(g=!1)});g&&l.push(b[i])}return l}});app.controller("ModalRechteController",["$scope","$uibModalStack","API",function(b,h,l){l.get("shopeinstellung/kundenrechte/"+b.Kunde.Nummer).then(function(g){b.Rechte=g});b.update=function(g){l.put("shopeinstellung/kundenrechte/"+b.Kunde.Nummer,g)};b.cancel=function(){var b=h.getTop();b&&h.dismiss(b.key)}}]);app.controller("ShopLieferbedingungenCtrl",["$scope","API","$uibModal","Alert","$timeout",function(b,h,l,g,f){var k;b.daten=[];b.Error3=!1;b.Error7=[];b.newLB={};b.newPS={};b.data={};h.get("lieferbedingung/data").then(function(e){e.daten&&(b.daten=e.daten);b.settings=e.settings});b.updateAnzeige=function(b){h.put("lieferbedingung/anzeige",b)};b.createLieferbedingung=function(e){g.close();h.post("lieferbedingung/data",e).then(function(d){1==d?(b.daten||(b.daten=[]),b.daten.push(e),b.newLB={},g.success("Neue Lieferbedingung erstellt!"),k&&f.cancel(k),k=f(function(){g.close()},5E3)):-1==d?g.fail("Lieferbedingung mit LB-Nr: "+e.LB+" bereits vorhanden!"):g.fail("'"+e.Versandartikel+"' ist kein g\u00fcltiger Artikel!")})};b.deleteLieferbedingung=function(e){g.close();h["delete"]("lieferbedingung/data/"+e).then(function(d){b.daten=d.daten;b.settings=d.settings;g.success("Lieferbedingung mit LB-Nr: "+e+" gel\u00f6scht!");k&&f.cancel(k);k=f(function(){g.close()},5E3)})};b.getDaten=function(e){h.get("lieferbedingung/data/"+e).then(function(d){b.data=d;b.PreisstaffelCopy=angular.copy(b.data.Preisstaffel)})};b.update=function(e,d,c){g.close();h.put("lieferbedingung/data/"+e,d).then(function(e){-1==e?g.fail("Kein g\u00fcltiger Artikel als Versandartikel \u00fcbergeben!"):(b.daten[c].LB=d.LB,b.daten[c].Versandartikel=d.Versandartikel,b.daten[c].Bezeichnung=d.Bezeichnung,b.daten[c].open=!1,g.success("Lieferbedingung erfolgreich ge\u00e4ndert!"),k&&f.cancel(k),k=f(function(){g.close()},5E3))})};b.addPreisstaffel=function(e){b.Error3=b.Error7_text=b.Error8=!1;e.LB=b.data.LB;if(b.data.Preisstaffel)for(i=0;i<b.data.Preisstaffel.length;i++){if(e.Umsatz==parseFloat(b.data.Preisstaffel[i].Umsatz)){b.Error3=!0;break}}else b.data.Preisstaffel=[];b.Error3||h.post("lieferbedingung/preisstaffel",e).then(function(d){-1==d?b.Error8=b.Error7_text=!0:(b.data.Preisstaffel.push(e),b.newPS={})})};b.removePreisstaffel=function(e,d){h["delete"]("lieferbedingung/preisstaffel/"+d.LB+"/"+d.Umsatz);b.data.Preisstaffel.splice(e,1)};b.updatePreisstaffel=function(e,d){b.Error6=b.Error7_text=b.Error7[e]=!1;for(i=0;i<b.data.Preisstaffel.length;i++)if(d.Umsatz==b.data.Preisstaffel[i].Umsatz&&e!=i){b.Error6=!0;b.Error6_Index=e;break}b.Error6||(h.put("lieferbedingung/preisstaffel/"+b.PreisstaffelCopy[e].Umsatz,d).then(function(c){-1==c&&(b.Error7[e]=b.Error7_text=!0)}),b.PreisstaffelCopy=angular.copy(b.data.Preisstaffel))};b.openGewichtstaffelModal=function(e){b.PS=e;l.open({animation:!1,size:"lg",backdrop:"static",templateUrl:"template/modalShopLieferbedingungGewichtstaffel.html",scope:b,controller:"ModalGewichtstaffelCtrl"})}}]);app.controller("ModalGewichtstaffelCtrl",["$scope","$uibModalStack","API",function(b,h,l){b.Error4=!1;b.Error5=!1;b.tmp={};b.newGS={LB:b.PS.LB,Umsatz:b.PS.Umsatz};l.get("lieferbedingung/gewichtstaffel",b.PS).then(function(g){b.data.Gewichtstaffel=g;b.tmp=angular.copy(b.data.Gewichtstaffel)});b.addGewichtstaffel=function(g){b.Error4=b.Error7_text=b.Error10=!1;for(i=0;i<b.data.Gewichtstaffel.length;i++)if(g.Gewicht==b.data.Gewichtstaffel[i].Gewicht){b.Error4=!0;break}b.Error4||l.post("lieferbedingung/gewichtstaffel",g).then(function(f){-1==f?b.Error7_text=b.Error10=!0:(b.data.Gewichtstaffel.push(g),b.newGS={LB:b.PS.LB,Umsatz:b.PS.Umsatz})})};b.updateGewichtstaffel=function(g,f){b.Error5=b.Error7[g]=b.Error7_text=!1;for(i=0;i<b.data.Gewichtstaffel.length;i++)if(f.Gewicht==b.data.Gewichtstaffel[i].Gewicht&&g!=i){b.Error5=!0;b.Error5_Index=g;break}b.Error5||(l.put("lieferbedingung/gewichtstaffel/"+b.tmp[g].Gewicht,f).then(function(f){-1==f&&(b.Error7[g]=b.Error7_text=!0)}),b.tmp=angular.copy(b.data.Gewichtstaffel))};b.removeGewichtstaffel=function(g,f){l["delete"]("lieferbedingung/gewichtstaffel/"+f.LB+"/"+f.Umsatz+"/"+f.Gewicht);b.data.Gewichtstaffel.splice(g,1)};b.cancel=function(){var b=h.getTop();b&&h.dismiss(b.key)}}]);app.controller("ShopNaturalzulagenCtrl",["$scope","API","$state","$uibModal","Alert","$timeout",function(b,h,l,g,f,k){var e="",d;b.Titel=l.current.title;e="Gutscheine"==l.current.title?"gutschein":"zulagen";b.values=[];b.v={};b.data={};b.x={};b.format="dd.MM.yyyy";b.dateOptions={maxDate:new Date(2020,11,31),minDate:new Date,startingDay:1};b.altInputFormats=["dd.MM.yyyy"];h.get("natural/"+e).then(function(c){b.values=c.Daten?c.Daten:[];b.laender=c.Laender});b.getDaten=function(c){b.showAlert=!1;h.get("natural/"+e+"/"+c).then(function(c){b.data=c;b.data.VonDatum&&(b.data.VonDatum=new Date(b.data.VonDatum));b.data.BisDatum&&(b.data.BisDatum=new Date(b.data.BisDatum))})};b["delete"]=function(c,g){b.values.splice(g,1);f.close();h["delete"]("natural/"+e+"/"+c).then(function(b){f.success("Zulage / Gutschein gel\u00f6scht!");d&&k.cancel(d);d=k(function(){f.close()},5E3)})};b.upload=function(b,d){b&&b.length&&(f.loading(!0),h.upload("natural/gutschein/upload",b[0],{NZNr:d}).then(function(b){-1==b&&f.fail("Fehler beim einlesen der CSV - Datei!");f.loading(!1)}))};b.save=function(c,g){f.close();c.VonDatum&&(c.VonDatum.setMinutes(c.VonDatum.getMinutes()-c.VonDatum.getTimezoneOffset()),c.VonDatum=c.VonDatum.toJSON().slice(0,10));c.BisDatum&&(c.BisDatum.setMinutes(c.BisDatum.getMinutes()-c.BisDatum.getTimezoneOffset()),c.BisDatum=c.BisDatum.toJSON().slice(0,10));h.put("natural/"+e,c).then(function(e){b.values[g].Codes={};b.values[g].open=!1;b.values[g].Codes.open=!1;c.Angebot||c.Bestellung||c.Lagerbuchung?c.VonDatum||c.BisDatum?(e=new Date,(new Date(c.VonDatum)).getTime()<=e.getTime()&&(new Date(c.BisDatum)).getTime()>=e.getTime()?b.values[g].Aktiv=!0:b.values[g].Aktiv=!1):b.values[g].Aktiv=!0:b.values[g].Aktiv=!1;f.success("\u00c4nderung gespeichert!");d&&k.cancel(d);d=k(function(){f.close()},5E3);window.scrollTo(0,0)})};b.getGutscheincodes=function(c){h.get("natural/"+e+"/codes/"+c).then(function(c){b.data.Gutscheincodes=c})};b.addGutscheincodes=function(c,d){h.post("natural/"+e+"/"+c,d).then(function(c){b.data.Gutscheincodes=c});b.v={}};b.deleteGutscheincode=function(c,d,f){h["delete"]("natural/"+e+"/"+d+"/"+f);b.data.Gutscheincodes.splice(c,1)};b.openModal=function(){b.x={};var c="Gutscheine"==l.current.title?"template/modalShopGutschein.html":"template/modalShopZulagen.html";b.showAlert=!1;g.open({animation:!1,size:"lg",backdrop:"static",templateUrl:c,scope:b,controller:"NaturalModalCtrl"})}}]);app.controller("NaturalModalCtrl",["$scope","API","$state","$uibModalStack","Alert","$timeout",function(b,h,l,g,f,k){var e="",d;b.Titel=l.current.title;e="Gutscheine"==l.current.title?"gutschein":"zulagen";b.addCSV=function(c){b.x.csv=c[0]};b.create=function(c){f.close();c.VonDatum&&(c.VonDatum.setMinutes(c.VonDatum.getMinutes()-c.VonDatum.getTimezoneOffset()),c.VonDatum=c.VonDatum.toJSON().slice(0,10));c.BisDatum&&(c.BisDatum.setMinutes(c.BisDatum.getMinutes()-c.BisDatum.getTimezoneOffset()),c.BisDatum=c.BisDatum.toJSON().slice(0,10));h.post("natural/"+e,c).then(function(e){c.NZNr=e.NZNr;c.csv&&h.upload("natural/gutschein/upload",c.csv,{NZNr:c.NZNr}).then(function(b){-1==b&&f.fail("Fehler beim Einlesen der CSV - Datei!")});if(c.Angebot||c.Bestellung||c.Lagerbuchung)if(c.VonDatum||c.BisDatum){e=new Date;var g=Date.parse(c.VonDatum),l=Date.parse(c.BisDatum);g<=e.getTime()&&l>=e.getTime()&&(c.Aktiv=!0)}else c.Aktiv=!0;b.values.push(c);b.x={};b.cancel();f.success("Zulage / Gutschein erstellt!");d&&k.cancel(d);d=k(function(){f.close()},5E3);window.scrollTo(0,0)})};b.cancel=function(){var b=g.getTop();b&&g.dismiss(b.key)}}]);app.directive("datetimepickerNeutralTimezone",function(){return{restrict:"A",priority:1,require:"ngModel",link:function(b,h,l,g){g.$formatters.shift();g.$formatters.push(function(b){if(b)return b=new Date(Date.parse(b)),b=new Date(b.getTime())});g.$parsers.push(function(b){if(b){var f=b.getDate(),e=b.getMonth()+1;b=b.getFullYear();return new Date(b+"-"+e+"-"+f)}})}}});app.directive("onReadFile",function(b){return{restrict:"A",scope:!1,link:function(h,l,g){var f=b(g.onReadFile);l.on("change",function(b){var e=new FileReader;e.onload=function(b){h.$apply(function(){f(h,{$fileContent:b.target.result})})};e.readAsText((b.srcElement||b.target).files[0])})}}});app.controller("ShopParameterCtrl",["$scope","API","Alert","$timeout",function(b,h,l,g){var f;h.get("parameter").then(function(f){b.data=f});b.save=function(b){l.close();h.put("parameter",b).then(function(b){window.scrollTo(0,0);l.success("\u00c4nderung gespeichert!");f&&g.cancel(f);f=g(function(){l.close()},5E3)})}}]);app.controller("ShopZahlungsbedingungenCtrl",["$scope","API","Alert","$timeout",function(b,h,l,g){var f;b.settings={};b.daten=[];b.data={};h.get("zahlungsbedingung/data").then(function(f){b.settings=f.Settings;b.daten=f.Daten});b.updateAnzeige=function(b){h.put("zahlungsbedingung/anzeige",b)};b.getDaten=function(f){h.get("zahlungsbedingung/data/"+f).then(function(e){b.data=e})};b.update=function(k){var e=k.Id-1;l.close();b.daten[e].aktiviert_nk=k.aktiviert_nk;b.daten[e].aktiviert_bk=k.aktiviert_bk;b.daten[e].aktiviert_sf=k.aktiviert_sf;h.put("zahlungsbedingung/data",k).then(function(b){l.success("\u00c4nderung gespeichert!");f&&g.cancel(f);f=g(function(){l.close()},5E3)})}}]);app.controller("TerminCtrl",["$scope","$rootScope","$uibModal","$stateParams","$state","$q","API","Alert",function(b,h,l,g,f,k,e,d){b.title=f.current.title;b.bereich=f.current.bereich;b.bereich_id=2;b.selectKat={};b.$watchGroup(["selectKat.hk","selectKat.k"],function(){b.search()});b.search=function(){b.rows=null;var c={};null!=b.selectKat.k&&(c.uk=b.selectKat.k.id);null!=b.selectKat.hk&&(c.hk=b.selectKat.hk.id);c.q="red,stamp,imgthumb,sichtbar,freigabeanforderung,date1,date2,archiv,upcoming,sicher";c.cms=!0;e.get("termin/search",c).then(function(c){b.rows=c.items?c.items:[];b.currentPage=1})};b.toggleSichtbar=function(b){var c=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?!0:!1:null==b.sichtbar||"0"==b.sichtbar?!0:!1;e.put("termin/sichtbar",{id:b.id,sichtbar:c}).then(function(){b.sichtbar=h.rechte.hasRedakteur?"0":c?"1":"0";b.freigabeanforderung=h.rechte.hasRedakteur?null==b.freigabeanforderung||"0"==b.freigabeanforderung?"1":"0":"0"})};b.openModal=function(c){l.open({animation:!1,backdrop:"static",templateUrl:"template/modalTermin.html",controller:"ModalTerminCtrl",resolve:{data:function(){return{id:c,selectKat:b.selectKat}}}}).result.then(function(){b.search()})};""!=g.id&&b.openModal(g.id)}]);app.controller("ModalTerminCtrl",["$scope","$rootScope","$uibModalInstance","$uibModal","$q","API","Alert","data",function(b,h,l,g,f,k,e,d){b.times="0:00 1:00 2:00 3:00 4:00 5:00 6:00 7:00 8:00 9:00 10:00 11:00 12:00 13:00 14:00 15:00 16:00 17:00 18:00 19:00 20:00 21:00 22:00 23:00".split(" ");b.minDate=new Date;b.termin={};b.data={image:null};b.setFile=function(c){b.file=c};b.$watch("file",function(c,d,e){b.filename=c?c.name:null});b.load=function(){d.id?k.get("termin/data/"+d.id,{q:"all",cms:!0}).then(function(c){b.termin=c;c.galerie||(b.termin.galerie=[]);c.katalog||(b.termin.katalog={items:[]});c.news||(b.termin.news={items:[]});c.termin||(b.termin.termin={items:[]});c.dokument||(b.termin.dokument=[]);c.nutzer||(b.termin.nutzer=[]);c.formular||(b.termin.formular=[]);c.artikel||(b.termin.artikel=[]);b.filename=c.doclink;b.termin.date1&&(b.termin.date1=new Date(b.termin.date1));b.termin.date2&&(b.termin.date2=new Date(b.termin.date2));h.kats[2].some(function(c){var d=!1;c.uks&&c.uks.some(function(e){if(e.id==b.termin.cat_nr)return b.hk=c,b.editable=e.edit,d=!0});return d})}):(b.termin={katalog:{items:[]},news:{items:[]},termin:{items:[]},dokument:[],galerie:[],nutzer:[],formular:[],artikel:[],date1:new Date},b.hk=d.selectKat.hk,d.selectKat.k&&(b.termin.cat_nr=d.selectKat.k.id))};b.load();b.deleteFile=function(){confirm("Dokument l\u00f6schen?")&&k["delete"]("termin/file/"+b.termin.id).then(function(){b.filename=null;b.termin.tdocnotation=null;b.termin.tdoclink=null})};b.deleteImage=function(){confirm("Bild l\u00f6schen?")&&k["delete"]("termin/img/"+b.termin.id).then(function(){b.imagename=null;b.termin.imgnotation=null;b.termin.imglink=null})};b.close=function(c){"post"==c?(e.loading(!0),k.post("termin/data",b.termin).then(function(c){var d=[];b.file&&d.push(k.upload("termin/file",b.file,{id:c}));b.data.image&&d.push(k.upload("termin/img",b.data.image,{id:c}));f.all(d).then(function(){e.loading(!1);l.close()})})):"put"==c?(e.loading(!0),c=[],c.push(k.put("termin/data",b.termin)),b.file&&c.push(k.upload("termin/file",b.file,{id:b.termin.id})),b.data.image&&c.push(k.upload("termin/img",b.data.image,{id:b.termin.id})),f.all(c).then(function(){e.loading(!1);l.close()})):"delete"==c?confirm("Termin l\u00f6schen?")&&(e.loading(!0),k["delete"]("termin/data/"+b.termin.id).then(function(){e.loading(!1);l.close()})):l.close()}}]);